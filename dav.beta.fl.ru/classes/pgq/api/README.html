<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.3.1" />
<title>PGQ-PHP</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock {
  padding-left: 2.0em;
}
div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock {
  padding-left: 2.0em;
}
div.verseblock > div.content {
  white-space: pre;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
div.olist > ol {
  list-style-type: decimal;
}
div.olist2 > ol {
  list-style-type: lower-alpha;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock-content {
  white-space: pre;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }

/* Because IE6 child selector is broken. */
div.olist2 ol {
  list-style-type: lower-alpha;
}
div.olist2 div.olist ol {
  list-style-type: decimal;
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){generateToc(2)}
/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, October 2006. License: GPL */

function getText(el) {
  var text = "";
  for (var i = el.firstChild; i != null; i = i.nextSibling) {
    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
      text += i.data;
    else if (i.firstChild != null)
      text += getText(i);
  }
  return text;
}

function TocEntry(el, text, toclevel) {
  this.element = el;
  this.text = text;
  this.toclevel = toclevel;
}

function tocEntries(el, toclevels) {
  var result = new Array;
  var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
  // Function that scans the DOM tree for header elements (the DOM2
  // nodeIterator API would be a better technique but not supported by all
  // browsers).
  var iterate = function (el) {
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
        var mo = re.exec(i.tagName)
        if (mo)
          result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
        iterate(i);
      }
    }
  }
  iterate(el);
  return result;
}

// This function does the work. toclevels = 1..4.
function generateToc(toclevels) {
  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementsByTagName("body")[0], toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "toc" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    document.getElementById("header").removeChild(toc);
}
/*]]>*/
</script>
</head>
<body>
<div id="header">
<h1>PGQ-PHP</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This project provides PHP level API to use the PGQ SQL API.</p></div>
<div class="paragraph"><p>Read more about PGQ here:
  <a href="http://skytools.projects.postgresql.org/doc/pgq-sql.html">http://skytools.projects.postgresql.org/doc/pgq-sql.html</a>
  <a href="http://www.pgcon.org/2008/schedule/events/79.en.html">http://www.pgcon.org/2008/schedule/events/79.en.html</a></p></div>
<div class="paragraph"><p>It then provides several kinds of Consumer that you&#8217;ll want to
extends. All the consumer wants you to implement your own
process_event(&amp;$event) callback function, and will care about PGQ
inner fonctionning.</p></div>
<div class="paragraph"><p>PGQ is about producing events in a (work) queue and having one or more
consumer get those events, in batches, and work on them. What the PHP
class to be presented here do is fetching the batches and calling your
own process_event() function for each event.</p></div>
</div>
<h2 id="_tools">Tools</h2>
<div class="sectionbody">
<h3 id="_simplelogger">SimpleLogger</h3><div style="clear:left"></div>
<div class="paragraph"><p>This class handles logging with a <tt>loglevel</tt>: only messages more
important than current <tt>loglevel</tt> are written to the logfile. The
levels are, by increasing order of importance:</p></div>
<div class="ulist"><ul>
<li>
<p>
DEBUG
</p>
</li>
<li>
<p>
VERBOSE
</p>
</li>
<li>
<p>
NOTICE
</p>
</li>
<li>
<p>
WARNING
</p>
</li>
<li>
<p>
ERROR
</p>
</li>
<li>
<p>
FATAL
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <tt>SimpleLogger</tt> offers a method for each <tt>loglevel</tt>, taking a
format string then arguments, just like <tt>sprintf()</tt> does. You have for
example</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>$logger-&gt;debug("a message with a '%s' string", $str);</tt></pre>
</div></div>
<h3 id="_systemdaemon">SystemDaemon</h3><div style="clear:left"></div>
<div class="paragraph"><p>This class implements a System Daemon controlled with commands. The
principle is to run in the background and loop forever, taking a
<tt>$this&#8594;delay</tt> rest whenever possible between two loops.</p></div>
<div class="paragraph"><p><tt>SystemDaemon</tt> uses SimpleLogger in <tt>$this&#8594;log</tt> instance, and have it
reopens its logfile at <tt>reload</tt> time. This means it plays well with
logrotate, just don&#8217;t forget to <tt>reload</tt> the daemon at logrotate
postprocess time.</p></div>
<div class="paragraph"><p>The commands available for any <tt>SystemDaemon</tt> are: <tt>start</tt>, <tt>stop</tt>,
<tt>kill</tt>, <tt>reload</tt>, <tt>restart</tt>, <tt>status</tt>, <tt>logless</tt>, <tt>logmore</tt>.</p></div>
<div class="paragraph"><p>The difference between <tt>stop</tt> and <tt>kill</tt> is that in the first case the
daemon will terminate current processing and only stops at next
opportunity to sleep for <tt>$this&#8594;delay</tt>, while <tt>kill</tt> forces it into
exiting (calling <tt>$this&#8594;stop()</tt>) first.</p></div>
<div class="paragraph"><p>The <tt>reload</tt> command will have the daemon call user defined
<tt>$this&#8594;reload()</tt> command at next sleep opportunity. This command
could e.g. read a configuration file and change settings.</p></div>
<div class="paragraph"><p>Commands <tt>logless</tt> and <tt>logmore</tt> are considered without delay and
makes the used logger to get instantly more or less verbose by
increasing or decreasing its <tt>loglevel</tt>. This is useful when you want
to know exactly what a daemon is doing now, but can&#8217;t afford to
restart it.</p></div>
<div class="paragraph"><p>When implementing a <tt>SystemDaemon</tt>, you get to just implement
<tt>$this&#8594;config()</tt> and <tt>$this&#8594;process()</tt> functions, which will get
called in the infinite looping. The former will only get called when a
reload has been ordered (<tt>SIGHUP</tt>), and the latter in each and every
loop.</p></div>
<div class="paragraph"><p>The <tt>SystemDaemon</tt> will also register its <tt>SimpleLogger</tt> instance as
the PHP error handler, and consider quitting when confronted to a PHP
FATAL errors (one of <tt>E_STRICT</tt>, <tt>E_PARSE</tt>, <tt>E_CORE_ERROR</tt>,
<tt>E_CORE_WARNING</tt>, <tt>E_COMPILE_ERROR</tt>, <tt>E_COMPILE_WARNING</tt>), and will
call user defined <tt>$this&#8594;php_error_hook()</tt> for PHP <tt>E_ERROR</tt> or
<tt>E_USER_ERROR</tt> level errors.</p></div>
<h3 id="_pgq">PGQ</h3><div style="clear:left"></div>
<div class="paragraph"><p>This class is abstract and has a <tt>public static</tt> method for each SQL
function that the PGQ SQL API offers. If PHP knew about namespaces or
modules, this would be a module.</p></div>
</div>
<h2 id="_consumers">Consumers</h2>
<div class="sectionbody">
<div class="paragraph"><p>Those class are the one handling how PGQ really works. They will get
batches from the queue, get events from them, allow you to process the
event by calling user defined <tt>$this&#8594;process_event(&amp;$event)</tt>
function, and call finish_batch() as appropriate.</p></div>
<div class="paragraph"><p>The <tt>$this&#8594;process_event()</tt> function should return one of those
return codes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
PGQ_EVENT_OK
</dt>
<dd>
<p>
  When the event processing is satisfactory.
</p>
</dd>
<dt class="hdlist1">
PGQ_EVENT_FAILED
</dt>
<dd>
<p>
  The event is tagged as failed with <tt>$event&#8594;failed_reason</tt> reason,
  and when using <tt>PGQEventRemoteConsumer</tt> the related processing done
  on remote database is rollbacked.
</p>
</dd>
<dt class="hdlist1">
PGQ_EVENT_RETRY
</dt>
<dd>
<p>
  The event is tagged as retry and will get reinserted into main queue
  after a minimum delay of <tt>$event&#8594;retry_delay</tt> seconds. When using
  <tt>PGQEventRemoteConsumer</tt> the related processing done on the remote
  database is rollbacked.
</p>
</dd>
<dt class="hdlist1">
PGQ_ABORT_BATCH
</dt>
<dd>
<p>
  All current batch processing is canceled, at both remote and queue
  database when using some sort of <tt>RemoteConsumer</tt>. The batch is not
  finished, so you&#8217;ll get the events back at next run(s).
</p>
</dd>
</dl></div>
<h3 id="_pgqconsumer">PGQConsumer</h3><div style="clear:left"></div>
<div class="paragraph"><p>This is a <tt>SystemDaemon</tt> which implements some more commands in order
to install the queue and register the consumer.</p></div>
<div class="paragraph"><p>When extending a <tt>PGQConsumer</tt>, you get to implement <tt>$this&#8594;config()</tt>
and <tt>$this&#8594;process_event()</tt> functions, and you&#8217;re done.</p></div>
<div class="paragraph"><p>The constructor needs a queue name (<tt>qname</tt>), a consumer name
(<tt>cname</tt>) and a database connection string.</p></div>
<div class="paragraph"><p>The added commands are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
install
</dt>
<dd>
<p>
  Create the queue <tt>qname</tt> and register a consumer <tt>cname</tt>.
</p>
</dd>
<dt class="hdlist1">
uninstall
</dt>
<dd>
<p>
  Unregister the consumer <tt>cname</tt> and drop the queue <tt>qname</tt>.
</p>
</dd>
<dt class="hdlist1">
check
</dt>
<dd>
<p>
  True only if the queue <tt>qname</tt> exists and the consumer <tt>cname</tt> is registered.
</p>
</dd>
<dt class="hdlist1">
create_queue
</dt>
<dd>
<p>
  Create the queue <tt>qname</tt>.
</p>
</dd>
<dt class="hdlist1">
drop_queue
</dt>
<dd>
<p>
  Drop the queue <tt>qname</tt>.
</p>
</dd>
<dt class="hdlist1">
register
</dt>
<dd>
<p>
  Register the consumer <tt>cname</tt>.
</p>
</dd>
<dt class="hdlist1">
unregister
</dt>
<dd>
<p>
  Unregister the consumer <tt>cname</tt>.
</p>
</dd>
<dt class="hdlist1">
failed
</dt>
<dd>
<p>
  Print out a list of failed events for queue <tt>qname</tt> and consumer
  <tt>cname</tt>.
</p>
</dd>
<dt class="hdlist1">
delete
</dt>
<dd>
<p>
  Delete given event id, or all failed events if given <tt>all</tt> as an
  event id.
</p>
</dd>
<dt class="hdlist1">
retry
</dt>
<dd>
<p>
  Retry given event id, or all failed events if given <tt>all</tt> as an
  event id.
</p>
</dd>
</dl></div>
<h3 id="_pgqinteractiveconsumer">PGQInteractiveConsumer</h3><div style="clear:left"></div>
<div class="paragraph"><p>This class assume the looping will get done elsewhere, at the calling
site for example. It consumes all available events (up until
next_batch() returns <tt>null</tt>).</p></div>
<div class="paragraph"><p>The lag is not controlled by the implementer class but rather by the
user of it.</p></div>
<div class="paragraph"><p>Implementer have to call <tt>$this&#8594;process()</tt>, which will start
consuming all available events and call the
<tt>$this&#8594;process_event(&amp;$event)</tt> hook for each event.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Internal design note
</dt>
<dd>
<p>
  <tt>PGQInteractiveRemoteConsumer</tt> needs to implement all PGQ methods
  for itself because of PHP limitation of extending from only one base
  class: <tt>PGQConsumer</tt> could not extends both <tt>SystemDaemon</tt> and
  <tt>PGQClass</tt>, where we should put the class abstraction over the API
  module.
</p>
</dd>
</dl></div>
<h3 id="_pgqremoteconsumer">PGQRemoteConsumer</h3><div style="clear:left"></div>
<div class="paragraph"><p><tt>PGQRemoteConsumer</tt> is a <tt>PGQConsumer</tt> controlling two PostgreSQL
connections and which will handle <tt>COMMIT</tt> and <tt>ROLLBACK</tt> nicely on
both of them.</p></div>
<div class="paragraph"><p>This means you want to use <tt>PGQRemoteConsumer</tt> when you&#8217;re processing
events from one database and apply changes to another one, the remote
one. The <tt>PGQRemoteConsumer</tt> takes advantage of the fact that the
remote processing is transactionnal (happens on a database) to get
sure any <tt>COMMIT</tt> ed work on remote connection is associated with
events properly consumed.</p></div>
<div class="paragraph"><p>Any error in event consuming or remote processing will cause the
current batch processing to be <tt>ROLLBACK</tt> ed at both points, meaning
the events will get consumed again later.</p></div>
<h3 id="_pgqeventremoteconsumer">PGQEventRemoteConsumer</h3><div style="clear:left"></div>
<div class="paragraph"><p>When you need to be able to <tt>COMMIT</tt> or <tt>ROLLBACK</tt> both transaction at
event level, <tt>PGQEventRemoteConsumer</tt> is what you&#8217;re after. It will
use a subtransaction (<tt>SAVEPOINT</tt>) for each event and will be able to
<tt>ROLLBACK TO SAVEPOINT</tt> on the remote side for any processing error
related to a single event processing.</p></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2009-03-17 22:44:18    
</div>
</div>
</body>
</html>
